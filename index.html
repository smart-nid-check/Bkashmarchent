<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>ржлрзЗрж╕ ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи + рж╕рзНржмрж╛ржХрзНрж╖рж░</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    video, canvas { width: 320px; height: 240px; margin-bottom: 10px; border: 1px solid #ccc; }
    canvas.signature { height: 150px; width: 320px; border: 1px dashed #000; }
    button { padding: 10px 20px; margin: 5px; background: green; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #999; cursor: not-allowed; }
    #result { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ржЕржЯрзЛ ржлрзЗрж╕ ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи ржУ рж╕рзНржмрж╛ржХрзНрж╖рж░</h2>

  <video id="video" autoplay muted></video><br>

  <h3>тЬНя╕П рж╕рзНржмрж╛ржХрзНрж╖рж░ ржжрж┐ржи</h3>
  <canvas id="signCanvas" class="signature" width="320" height="150"></canvas><br>
  <button id="clearSign">ЁЯз╣ ржорзБржЫрзБржи</button>
  <button id="submit" disabled>ЁЯУд рж╕рж╛ржмржорж┐ржЯ</button>

  <p id="result">ржорзБржЦ рж╢ржирж╛ржХрзНржд ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...</p>

  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <script>
    const video = document.getElementById('video');
    const signCanvas = document.getElementById('signCanvas');
    const signCtx = signCanvas.getContext('2d');
    const clearSignBtn = document.getElementById('clearSign');
    const submitBtn = document.getElementById('submit');
    const result = document.getElementById('result');

    let stream;
    let mediaRecorder;
    let recordedChunks = [];
    let recording = false;
    let videoBlob = null;
    let drawing = false;

    // ржХрзНржпрж╛ржорзЗрж░рж╛ ржЪрж╛рж▓рзБ ржУ ржоржбрзЗрж▓ рж▓рзЛржб
    async function startCameraAndModels() {
      await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights');
      stream = await navigator.mediaDevices.getUserMedia({ video: {} });
      video.srcObject = stream;
      video.style.display = 'block';
      video.play();

      detectFace();
    }

    // ржлрзЗрж╕ ржбрж┐ржЯрзЗржХрж╢ржи ржУ ржЕржЯрзЛ рж░рзЗржХрж░рзНржбрж┐ржВ
    async function detectFace() {
      const options = new faceapi.TinyFaceDetectorOptions();
      const detections = await faceapi.detectAllFaces(video, options);

      if (detections.length > 0) {
        if (!recording) startRecording();
      } else {
        if (!recording) result.textContent = "ржорзБржЦ рж╢ржирж╛ржХрзНржд ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...";
      }

      requestAnimationFrame(detectFace);
    }

    function startRecording() {
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };
      mediaRecorder.onstop = () => {
        videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
        stopCamera();
        result.textContent = "тЬЕ ржнрж┐ржбрж┐ржУ рж░рзЗржХрж░рзНржб рж╕ржорзНржкржирзНржи рж╣рзЯрзЗржЫрзЗред ржПржЦржи рж╕рзНржмрж╛ржХрзНрж╖рж░ ржжрж┐ржи ржПржмржВ рж╕рж╛ржмржорж┐ржЯ ржХрж░рзБржиред";
        submitBtn.disabled = false;
      };
      mediaRecorder.start();
      recording = true;
      result.textContent = "ЁЯФ┤ ржнрж┐ржбрж┐ржУ рж░рзЗржХрж░рзНржбрж┐ржВ рж╢рзБрж░рзБ рж╣рзЯрзЗржЫрзЗ...";
      setTimeout(() => {
        mediaRecorder.stop();
        recording = false;
      }, 5000);
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.pause();
        video.srcObject = null;
        video.style.display = 'none';
      }
    }

    // рж╕рзНржмрж╛ржХрзНрж╖рж░ ржЖржБржХрж╛
    signCanvas.addEventListener('mousedown', e => { drawing = true; signCtx.beginPath(); });
    signCanvas.addEventListener('mouseup', () => drawing = false);
    signCanvas.addEventListener('mouseleave', () => drawing = false);
    signCanvas.addEventListener('mousemove', e => { if (drawing) draw(e); });

    signCanvas.addEventListener('touchstart', e => { drawing = true; signCtx.beginPath(); draw(e.touches[0]); });
    signCanvas.addEventListener('touchend', () => drawing = false);
    signCanvas.addEventListener('touchcancel', () => drawing = false);
    signCanvas.addEventListener('touchmove', e => { if (drawing) { draw(e.touches[0]); e.preventDefault(); } });

    function draw(e) {
      const rect = signCanvas.getBoundingClientRect();
      signCtx.lineWidth = 2;
      signCtx.strokeStyle = 'black';
      signCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      signCtx.stroke();
      signCtx.beginPath();
      signCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    // рж╕рзНржмрж╛ржХрзНрж╖рж░ ржорзБржЫрзБржи
    clearSignBtn.onclick = () => {
      signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
    };

    // ржЪрзЗржХ рж╕рзНржмрж╛ржХрзНрж╖рж░ ржлрж╛ржБржХрж╛ ржХрж┐ржирж╛
    function signCanvasIsEmpty() {
      const blank = document.createElement('canvas');
      blank.width = signCanvas.width;
      blank.height = signCanvas.height;
      return signCanvas.toDataURL() === blank.toDataURL();
    }

    // рж╕рж╛ржмржорж┐ржЯ
    submitBtn.onclick = () => {
      if (!videoBlob) return alert('тЪая╕П ржнрж┐ржбрж┐ржУ рж░рзЗржХрж░рзНржб ржХрж░рзЗржиржирж┐!');
      if (signCanvasIsEmpty()) return alert('тЪая╕П рж╕рзНржмрж╛ржХрзНрж╖рж░ ржжрж┐ржи!');

      // ржПржЦрж╛ржирзЗ ржЖржкржирж┐ API ржХрж▓ ржмрж╛ ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░рзЗржи,
      // ржПржЦржи ржбрзЗржорзЛ ржорзЛржбрзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ success ржорзЗрж╕рзЗржЬ ржжрзЗржЦрж╛ржмрзЛ

      result.textContent = 'ЁЯУд ржпрж╛ржЪрж╛ржЗ ржЪрж▓ржЫрзЗ...';

      setTimeout(() => {
        result.textContent = 'тЬЕ ржЖржкржирж╛рж░ ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи рж╕ржлрж▓ рж╣рзЯрзЗржЫрзЗ!';
        submitBtn.disabled = true;
      }, 1000);
    };

    // ржкрзЗржЬ рж▓рзЛржбрзЗ ржХрзНржпрж╛ржорзЗрж░рж╛ ржУ ржоржбрзЗрж▓ рж╢рзБрж░рзБ
    startCameraAndModels();
  </script>
</body>
</html>
